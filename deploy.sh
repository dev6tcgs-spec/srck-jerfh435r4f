#!/bin/bash
# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั ะฝะฐ VDS

echo "๐ ะะฐัะฐะปะพ ะดะตะฟะปะพั ะฑะพัะฐ..."

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฑะพัะฐ ะตัะปะธ ะทะฐะฟััะตะฝ
echo "โน ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ..."
pkill -f "python.*bot.py" || true
sleep 2

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd ~/zimamos || exit 1

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
if [ ! -d "venv" ]; then
    echo "๐ฆ ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    python3 -m venv venv
fi

source venv/bin/activate

# ะะฑะฝะพะฒะปัะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -r requirements.txt --quiet

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ ะะจะะะะ: ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
mkdir -p logs

# ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ัะพะฝะต ั ะฟะตัะตะฝะฐะฟัะฐะฒะปะตะฝะธะตะผ ะฒัะฒะพะดะฐ
echo "โถ ะะฐะฟััะบ ะฑะพัะฐ..."
nohup venv/bin/python bot.py > logs/bot_stdout.log 2> logs/bot_stderr.log &

# ะะดะตะผ ะฝะตะผะฝะพะณะพ
sleep 3

# ะัะพะฒะตััะตะผ, ััะพ ะฟัะพัะตัั ะทะฐะฟััะตะฝ
if pgrep -f "python.*bot.py" > /dev/null; then
    echo "โ ะะพั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ PID: $(pgrep -f 'python.*bot.py')"
    echo "๐ ะะพะณะธ: logs/bot_$(date +%Y-%m-%d).log"
    echo "โ ะัะธะฑะบะธ: logs/errors.log"
else
    echo "โ ะะจะะะะ: ะะพั ะฝะต ะทะฐะฟัััะธะปัั!"
    echo "ะัะพะฒะตัััะต ะปะพะณะธ: tail -f logs/bot_stderr.log"
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"

